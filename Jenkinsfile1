pipeline {
    agent any
    
    environment {
        SLACK_CHANNEL = '#purple'
        DOCKER_IMAGE = 'portfolio'
        DOCKER_TAG = "dev-${env.BUILD_NUMBER}"
    }
    
    // SOLUTION: Utiliser le polling SCM √† la place des webhooks
    triggers {
        // V√©rifie les changements toutes les 1 minute
        pollSCM('* * * * *')
    }
    
    stages {
        stage('D√©tection Commit') {
            steps {
                script {
                    // R√©cup√©rer les infos du commit
                    def commitHash = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    def commitMessage = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                    def author = sh(script: 'git log -1 --pretty=%an', returnStdout: true).trim()
                    
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "good",
                        message: """üöÄ NOUVEAU COMMIT D√âTECT√â - Build #${env.BUILD_NUMBER}
üìù Message: ${commitMessage}
üë§ Auteur: ${author}
üîó Commit: ${commitHash}
üåø Branch: ${env.GIT_BRANCH}"""
                    )
                }
            }
        }

        stage('Clone') {
            steps {
                script {
                    slackSend channel: ${env.SLACK_CHANNEL}, 
                             color: 'good', 
                             message: "üöÄ D√©but du pipeline - Build #${env.BUILD_NUMBER}\nBranche: ${env.GIT_BRANCH}"
                    
                    echo "Clonage du d√©p√¥t de la branche dev..."
                    checkout scmGit(
                        branches: [[name: 'dev']],
                        userRemoteConfigs: [[url: 'https://github.com/yeillenr/mon-portfolio.git']]
                    )
                }
            }
            post {
                success {
                    slackSend channel: ${env.SLACK_CHANNEL}, 
                             color: 'good', 
                             message: "‚úÖ Stage CLONE r√©ussi\nRepository: mon-portfolio\nCommit: ${sh(script: 'git log -1 --oneline', returnStdout: true).trim()}"
                }
                failure {
                    slackSend channel:${env.SLACK_CHANNEL}, 
                             color: 'danger', 
                             message: "‚ùå √âchec du stage CLONE\nErreur: Impossible de cloner le d√©p√¥t"
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                     echo "Construction de l'image Docker du portfolio..."
                    // Build de l'image Docker √† partir du Dockerfile pr√©sent dans le d√©p√¥t
                    docker.build("${env.DOCKER_IMAGE}:${env.DOCKER_TAG}")
                }
                post {
                    success {
                        slackSend channel: ${env.SLACK_CHANNEL}, 
                                 color: 'good', 
                                 message: "‚úÖ Stage BUILD r√©ussi\nImage: ${env.DOCKER_IMAGE}:${env.DOCKER_TAG}"
                    }
                    failure {
                        slackSend channel: env.SLACK_CHANNEL, 
                                 color: 'danger', 
                                 message: "‚ùå √âchec du stage BUILD\nErreur: √âchec de la construction Docker"
                    }
                }
            }
        
        stage('Deploy') {
            steps {
                script {
                    echo "D√©ploiement du portfolio..."
                    
                    // Arr√™ter et supprimer l'ancien conteneur s'il existe
                    sh '''
                        docker stop portfolio-dev || true
                        docker rm portfolio-dev || true
                    '''
                    
                    // Lancer le nouveau conteneur
                    sh "docker run -d --name portfolio-dev -p 8080:80 ${env.DOCKER_IMAGE}:${env.DOCKER_TAG}"
                    
                    // Attendre que l'application soit pr√™te
                    sleep 5
                    
                    // Test du d√©ploiement
                    sh "curl -f http://localhost:8080 || exit 1"
                }
            }
            post {
                success {
                    slackSend channel: ${env.SLACK_CHANNEL}, 
                             color: 'good', 
                             message: "‚úÖ Stage DEPLOY r√©ussi\nPortfolio d√©ploy√©: http://localhost:8080\nConteneur: portfolio-dev"
                }
                failure {
                    slackSend channel: ${env.SLACK_CHANNEL}, 
                             color: 'danger', 
                             message: "‚ùå √âchec du stage DEPLOY\nErreur: Impossible de d√©ployer le portfolio"
                    
                    // Nettoyage en cas d'√©chec
                    sh '''
                        docker stop portfolio-dev || true
                        docker rm portfolio-dev || true
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline termin√© - R√©sultat: ${currentBuild.result}"
            // Notification globale du statut du pipeline
            script {
                if (currentBuild.result == 'SUCCESS') {
                    slackSend channel: ${env.SLACK_CHANNEL}, 
                             color: 'good', 
                             message: "üéâ Pipeline TERMIN√â - Build #${env.BUILD_NUMBER} r√©ussi\nD√©tails: ${env.BUILD_URL}"
                } else if (currentBuild.result == 'FAILURE') {
                    slackSend channel: ${env.SLACK_CHANNEL}, 
                             color: 'danger', 
                             message: "üí• Pipeline √âCHOU√â - Build #${env.BUILD_NUMBER} en √©chec\nD√©tails: ${env.BUILD_URL}"
                } else {
                    slackSend channel: ${env.SLACK_CHANNEL}, 
                             color: 'warning', 
                             message: "‚ö†Ô∏è Pipeline Termin√© - Build #${env.BUILD_NUMBER} avec statut: ${currentBuild.result}\nD√©tails: ${env.BUILD_URL}"
                }
            }
        }
    }
 }
}
