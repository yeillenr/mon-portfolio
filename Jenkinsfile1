pipeline {
    agent any
    
    environment {
        SLACK_CHANNEL = '#purple'
    }
    
    // SOLUTION: Utiliser le polling SCM Ã  la place des webhooks
    triggers {
        // VÃ©rifie les changements toutes les 1 minute
        pollSCM('* * * * *')
    }
    
    stages {
        stage('DÃ©tection Commit') {
            steps {
                script {
                    // RÃ©cupÃ©rer les infos du commit
                    def commitHash = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    def commitMessage = sh(script: 'git log -1 --pretty=%B', returnStdout: true).trim()
                    def author = sh(script: 'git log -1 --pretty=%an', returnStdout: true).trim()
                    
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "good",
                        message: """ðŸš€ NOUVEAU COMMIT DÃ‰TECTÃ‰ - Build #${env.BUILD_NUMBER}
ðŸ“ Message: ${commitMessage}
ðŸ‘¤ Auteur: ${author}
ðŸ”— Commit: ${commitHash}
ðŸŒ¿ Branch: ${env.GIT_BRANCH}"""
                    )
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "warning",
                        message: "ðŸ”¨ DÃ©but BUILD - Build #${env.BUILD_NUMBER}"
                    )
                }
                
                echo "Construction en cours..."
                
                script {
                    if (fileExists('package.json')) {
                        echo "Projet Node.js dÃ©tectÃ©"
                        sh 'npm install && npm run build'
                    } else {
                        echo "Build simulÃ©"
                        sh 'echo "Build rÃ©ussi" > build.log'
                    }
                }
                
                script {
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "good", 
                        message: "âœ… BUILD rÃ©ussi - Build #${env.BUILD_NUMBER}"
                    )
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "warning",
                        message: "ðŸš€ DÃ©but DEPLOIEMENT - Build #${env.BUILD_NUMBER}"
                    )
                }
                
                echo "DÃ©ploiement en cours..."
                sh 'echo "DÃ©ploiement rÃ©ussi" > deploy.log'
                
                script {
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "good",
                        message: "âœ… DEPLOIEMENT terminÃ© - Build #${env.BUILD_NUMBER}"
                    )
                }
            }
        }
    }
}
