pipeline {
    agent any
    
    environment {
        SLACK_CHANNEL = '#purple'
    }
    
    triggers {
        githubPush()
        pollSCM('H/5 * * * *')
    }
    
    stages {
        stage('Clone') {
            steps {
                script {
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "good",
                        message: "üöÄ D√©but du pipeline - Build #${env.BUILD_NUMBER}\nBranch: dev\nRepository: mon-portfolio"
                    )
                }
                
                echo "Code d√©j√† clon√© par SCM, pr√©paration du build..."
                // Le code est automatiquement clon√© par Jenkins au d√©but
            }
        }
        
        stage('Build') {
            steps {
                script {
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "warning",
                        message: "üî® D√©but BUILD - Build #${env.BUILD_NUMBER}"
                    )
                }
                
                echo "Building application..."
                
                // SOLUTION : V√©rifier le type de projet et adapter les commandes
                script {
                    // V√©rifier si c'est un projet Node.js
                    if (fileExists('package.json')) {
                        echo "Projet Node.js d√©tect√©"
                        sh 'npm install'
                        sh 'npm run build'
                    }
                    // V√©rifier si c'est un projet Maven
                    else if (fileExists('pom.xml')) {
                        echo "Projet Maven d√©tect√©"
                        // Installer Maven temporairement ou utiliser un agent avec Maven
                        sh '''
                            which mvn || echo "Maven non install√©"
                            # Solution temporaire - installation de Maven
                            wget https://archive.apache.org/dist/maven/maven-3/3.8.6/binaries/apache-maven-3.8.6-bin.tar.gz
                            tar -xzf apache-maven-3.8.6-bin.tar.gz
                            ./apache-maven-3.8.6/bin/mvn clean compile
                        '''
                    }
                    else {
                        echo "Aucun fichier de build d√©tect√©, build simul√©"
                        sh 'echo "Build simul√© r√©ussi" > build.log'
                        sh 'ls -la'
                    }
                }
                
                script {
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "good",
                        message: "‚úÖ BUILD r√©ussi - Build #${env.BUILD_NUMBER}"
                    )
                }
            }
            
            post {
                failure {
                    script {
                        slackSend(
                            channel: "${env.SLACK_CHANNEL}",
                            color: "danger",
                            message: "‚ùå √âchec BUILD - Build #${env.BUILD_NUMBER}\nErreur: Commande de build non trouv√©e"
                        )
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "warning",
                        message: "üöÄ D√©but DEPLOIEMENT - Build #${env.BUILD_NUMBER}"
                    )
                }
                
                echo "Deploying application..."
                
                // Adaptez selon votre m√©thode de d√©ploiement
                script {
                    if (fileExists('build')) {
                        echo "D√©ploiement des fichiers de build"
                        sh 'ls -la build/ || ls -la'
                    } else {
                        echo "D√©ploiement simul√©"
                        sh 'echo "D√©ploiement r√©ussi" > deploy.log'
                    }
                }
                
                script {
                    slackSend(
                        channel: "${env.SLACK_CHANNEL}",
                        color: "good",
                        message: "‚úÖ DEPLOIEMENT r√©ussi - Build #${env.BUILD_NUMBER}"
                    )
                }
            }
            
            post {
                failure {
                    script {
                        slackSend(
                            channel: "${env.SLACK_CHANNEL}",
                            color: "danger",
                            message: "‚ùå √âchec DEPLOIEMENT - Build #${env.BUILD_NUMBER}"
                        )
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                def color = currentBuild.result == 'SUCCESS' ? "good" : "danger"
                def message = currentBuild.result == 'SUCCESS' ? 
                    "üìä PIPELINE R√âUSSI - Build #${env.BUILD_NUMBER}" :
                    "üìä PIPELINE √âCHOU√â - Build #${env.BUILD_NUMBER}"
                
                slackSend(
                    channel: "${env.SLACK_CHANNEL}",
                    color: color,
                    message: "${message}\nDur√©e: ${currentBuild.durationString}\nD√©tails: ${env.BUILD_URL}"
                )
            }
        }
    }
}
