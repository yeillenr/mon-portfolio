pipeline {
    agent any
    
    triggers {
        pollSCM('H/5 * * * *') // V√©rifie les changements toutes les 5 minutes
        // OU pour webhook GitHub :
        // github(triggerOnPush: true, branchFilter: 'dev')
    }
    
    environment {
        SLACK_CHANNEL = '#purple'
        BUILD_URL = env.BUILD_URL
    }
    
    stages {
        stage('Clone') {
            steps {
                script {
                    slackSend(
                        channel: "${SLACK_CHANNEL}",
                        color: "good",
                        message: "üöÄ D√©but du pipeline - Build #${BUILD_NUMBER}\nBranch: ${env.GIT_BRANCH}\nCommit: ${env.GIT_COMMIT}"
                    )
                }
                
                echo "Cloning repository from branch dev..."
                git branch: 'dev', 
                    url: 'https://github.com/yeillenr/mon-portfolio',
                    credentialsId: 'tokengit'
                
                script {
                    slackSend(
                        channel: "${SLACK_CHANNEL}",
                        color: "good",
                        message: "‚úÖ √âtape CLONE termin√©e - Build #${BUILD_NUMBER}"
                    )
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    slackSend(
                        channel: "${SLACK_CHANNEL}",
                        color: "warning",
                        message: "üî® D√©but de l'√©tape BUILD - Build #${BUILD_NUMBER}"
                    )
                }
                
                echo "Building application..."
                // Adaptez selon votre technologie
                sh 'mvn clean compile'
                // ou sh 'npm install'
                // ou sh 'docker build -t votre-app .'
                
                script {
                    slackSend(
                        channel: "${SLACK_CHANNEL}",
                        color: "good",
                        message: "‚úÖ √âtape BUILD termin√©e - Build #${BUILD_NUMBER}"
                    )
                }
            }
            
            post {
                failure {
                    script {
                        slackSend(
                            channel: "${SLACK_CHANNEL}",
                            color: "danger",
                            message: "‚ùå √âchec BUILD - Build #${BUILD_NUMBER}\nErreur: ${currentBuild.result}"
                        )
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    slackSend(
                        channel: "${SLACK_CHANNEL}",
                        color: "warning",
                        message: "üöÄ D√©but du DEPLOIEMENT - Build #${BUILD_NUMBER}"
                    )
                }
                
                echo "Deploying to environment..."
                // Adaptez selon votre m√©thode de d√©ploiement
                sh 'mvn deploy'
                // ou sh 'kubectl apply -f deployment.yaml'
                // ou sh 'scp target/app.ws user@server:/path'
                
                script {
                    slackSend(
                        channel: "${SLACK_CHANNEL}",
                        color: "good",
                        message: "‚úÖ D√âPLOIEMENT R√âUSSI - Build #${BUILD_NUMBER}\nApplication d√©ploy√©e avec succ√®s!"
                    )
                }
            }
            
            post {
                failure {
                    script {
                        slackSend(
                            channel: "${SLACK_CHANNEL}",
                            color: "danger",
                            message: "‚ùå √âchec DEPLOIEMENT - Build #${BUILD_NUMBER}\nErreur: ${currentBuild.result}"
                        )
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                slackSend(
                    channel: "${SLACK_CHANNEL}",
                    color: currentBuild.result == 'SUCCESS' ? "good" : "danger",
                    message: "üìä R√©sultat final - Build #${BUILD_NUMBER}: ${currentBuild.result}\nDur√©e: ${currentBuild.durationString}\nVoir les d√©tails: ${BUILD_URL}"
                )
            }
        }
    }
}
